{% extends 'base.html' %}

{% block content %}
  <h3>COVID Vaccination Data Exploration</h3>
  <!-- could add little picture or something? -->
  <p>
    This project aims to explore data surrounding COVID cases and vaccinations in the United States. 
    Below, we have created a dashboard that will allow users to explore predicted outcomes based on changes 
    to future vaccination rates. Users can investigate how the case rates of their chosen state may change 
    over the coming months if their state changes their vaccination rate. There are additional visualizations 
    under the 'Data Exploration' section that display information regarding state demographic information, 
    the relationship between COVID cases and influenza-like illnesses, state policy decisions, and vaccine 
    administration and distribution.
  </p>
  <section>
    <h1 id="predictions">Predictions</h1>
    <p>
      Showing data for <b>{{ state }}</b> and assuming that the future 
      vaccination rate will be <b>{{ multiplier }}x</b> the past vaccination rate. </br>
      The predictions below use a linear regression model which predicts the following day's case counts based on the preceding 32 days.
      Multi-day predictions are generated by recursively predicting a future days' case counts with the past day's assumed 
      counts as inputs. For state predictions, average observed prediction error is displayed on the graph, denoting the range 
      in which the future value is likely to fall. </br>
      <i>Note that these predictions are calculated using statistical models to find likely outcomes. Actual future case counts may differ.</i>
    </p>

    <!-- Dropdowns-->
    <div class="row">
      <div class="col-auto">
        <div class="dropdown">
          <button class="btn btn-info dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Select State
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            {% for state_name in all_states.keys() %}
            <a class="dropdown-item" href="?state={{ all_states[state_name]}}&multiplier={{multiplier}}">{{ state_name }}</a>
            {% endfor %}
          </div>
        </div>

      </div>
      <div class="col-auto">
        <div class="dropdown">
          <button class="btn btn-info dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Select Future Vaccination Rate
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <a class="dropdown-item" href="?state={{state}}&multiplier=0.5">0.5x Past Rate</a>
            <a class="dropdown-item" href="?state={{state}}&multiplier=0.75">0.75x Past Rate</a>
            <a class="dropdown-item" href="?state={{state}}&multiplier=1">1x Past Rate</a>
            <a class="dropdown-item" href="?state={{state}}&multiplier=1.25">1.25x Past Rate</a>
            <a class="dropdown-item" href="?state={{state}}&multiplier=1.5">1.5x Past Rate</a>
            <a class="dropdown-item" href="?state={{state}}&multiplier=2">2x Past Rate</a>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div id="prediction_dataviz"></div>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <p>The unadjusted future vaccination rate is based on data from the last 14 days.</p>
        <div id="vaccine_dataviz"></div>
      </div>
    </div>
    <script>
      // convert the data from json to a JS object
      var dailyCases = {{ daily_cases|tojson }};
      var dailyVaccinations = {{ daily_vaccinations|tojson }};
      var futureVaccinations = {{ future_vaccinations|tojson }}
      var predictedCases = {{ predictions|tojson }}
      var bounds = {{ bounds|tojson }}
      
      // create the visualizations
      render_prediction_visualization(dailyCases, predictedCases, bounds)
      render_vaccine_visualization(dailyVaccinations, futureVaccinations)
    </script>
  </section>
  <section>
    <h1 id="exploration">Data Exploration</h1>
    <div class="row">
      <div class="col">
        <p>
          Demographics can be filtered and isolated by double clicking the name of the demographic on the legend on the right.
          After isolating one, you can include others by clicking once on the name.
          <br><br>
          To reset, double click anywhere on the legend to display all demographics again.
        </p>
        <div id="population_dataviz"></div>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <br><br>
        <p>
          Peak flu activity according to the CDC is highlighted on the chart below in red. Typically, the flu virus is most common during 
          the fall and winter, and peaks from December to February. 
          <span class="font-italic">Source: <a href="https://www.cdc.gov/flu/about/season/flu-season.htm" target="_blank">The Flu Season (CDC)</a></span>
          <br><br>
          We can see below there isn't much of a spike in influenza-like illnesses as would be expected between December 2020 to February 2021, unlike the flu season 
          peak visible from January 2020 through mid-March 2020. Instead, we see a peak of COVID-19 cases.
        </p>
        <div id="influenza_dataviz"></div>
      </div>
    </div>
    <div class="col-auto">
      <p>
        Showing data for the <b>{{ policy }}</b> state policy action.
        <br><br>
        Click the dropdown to select a different state policy action.
      </p>
      <div class="dropdown">
        <button class="btn btn-info dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Select State Policy Action
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
          {% for policy_name in state_policies %}
          <a class="dropdown-item" href="?policy={{policy_name|urlencode}}">{{ policy_name }}</a>
          {% endfor %}
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <div id="policy_dataviz"></div>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <div id="total_vax_dataviz"></div>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <div id="distrib_vax_dataviz"></div>
      </div>
    </div>
    <script>
      // convert the data from json to a JS object
      var demographicInfo = {{ state_demographic_dict|tojson }};
      var nationalCases = {{ national_cases_dict|tojson }};
      var influenzaCounts = {{ influenza_counts|tojson }};  
      var nationalTotalVaccinations = {{ national_total_vax_dict|tojson }};
      var nationalDistribVaccinations = {{ national_distrib_vax_dict|tojson }};
      var statePolicyInfo = {{ state_policy_dict|tojson }};
      var stateName = {{ state|tojson }};

      // data only accessible if we are looking at a singular state
      if (stateName !== 'US') {
        var casesAndDeaths = {{ total_cases_and_deaths_dict|tojson }};
      };
      
      // create the visualizations
      render_population_visualization(demographicInfo, casesAndDeaths)
      render_influenza_visualization(influenzaCounts, nationalCases)
      render_total_vax_visualization(nationalTotalVaccinations)
      render_distrib_vax_visualization(nationalDistribVaccinations)
      render_policy_visualization(statePolicyInfo)
    </script>
  </section>
{% endblock %}